<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finalizar assinatura — Anjo da Guarda | 3G Brasil</title>
  <meta name="description" content="Finalização da assinatura do aplicativo Anjo da Guarda da 3G Brasil.">
  <link rel="stylesheet" href="assets/site.css?v=3">

  <style>
    main.container{
      max-width: 980px;
      margin: 0 auto;
      padding: 32px 16px 64px;
    }
    .page-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items:start;
    }
    .card-form-page{
      max-width: 520px;
    }
    .card-form-page label{
      display:block;
      margin-bottom:12px;
      font-size:.95rem;
    }
    .card-form-page input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size: .98rem;
      outline:none;
    }
    .card-form-page input:focus{
      border-color:#1d4ed8;
      box-shadow:0 0 0 3px rgba(29,78,216,.12);
    }
    .card-row{
      display:flex;
      gap:12px;
    }
    .card-row label{ flex:1; }

    .terms-actions{
      display:flex;
      gap:12px;
      margin-top:20px;
      flex-wrap:wrap;
    }
    .terms-actions button{
      flex:1 0 auto;
      min-width: 180px;
      min-height:48px;
      border-radius:999px;
      padding:12px 16px;
      font-weight:600;
      border:none;
      cursor:pointer;
    }
    .btn-outline{ background:#fff;border:1px solid #d1d5db;color:#111;}
    .btn-link{ background:#0b132b;color:#e8eaed;}
    .btn-outline:hover{background:#f3f4f6;}
    .btn-link:hover{opacity:.92;}

    .note{
      font-size:.9rem;
      color:#6b7280;
      margin:10px 0 0;
      line-height:1.45;
    }

    .inline-feedback{
      font-size:.85rem;
      margin-top:6px;
      color:#6b7280;
    }

    .summary{
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:14px 14px;
      background:#fafafa;
      margin-top: 10px;
    }
    .summary h3{
      margin:0 0 10px 0;
      font-size: 1rem;
    }
    .summary-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:6px 0;
      border-bottom:1px dashed #e5e7eb;
      font-size:.95rem;
    }
    .summary-row:last-child{ border-bottom:0; }
    .summary strong{ font-weight:700; }
    .summary .total{
      font-size:1.05rem;
      color:#0b132b;
    }

    @media (max-width:640px){
      .card-row{ flex-direction:column; }
      .terms-actions button{ min-width: 0; flex:1; }
      .card-form-page{ max-width: 100%; }
    }
  </style>
</head>

<body>
  <header>
    <div class="logo-band">
      <img src="assets/logo.png" alt="3G Brasil" loading="lazy">
    </div>

    <nav>
      <a href="/">3G Brasil</a>
      <a href="/#produtos">Produtos</a>
      <a href="/contact.html">Contato</a>
      <a href="/cancelar.html">Cancelar assinatura</a>
    </nav>
  </header>

  <main class="container">
    <section class="page-grid">
      <div>
        <h1 style="margin:0 0 6px 0;">Finalizar assinatura</h1>
        <p class="terms-plan" style="margin:0 0 14px 0;">
          Plano selecionado: <strong id="selected-plan-card">—</strong>
        </p>

        <form class="card-form card-form-page" id="form-assinatura" onsubmit="return false;">
          <label>
            Nome completo
            <input type="text" id="card-name" autocomplete="name" required>
          </label>

          <label>
            E-mail
            <input type="email" id="card-email" autocomplete="email" required>
          </label>

          <label>
            Telefone (WhatsApp)
            <input type="tel" id="card-phone" placeholder="+55 11 99999-9999" autocomplete="tel" required>
          </label>

          <!-- NOVO: Código do vendedor -->
          <label>
            Código do vendedor (opcional)
            <input type="text" id="seller-code" placeholder="Ex.: VD-AB12" autocomplete="off">
            <div class="inline-feedback" id="seller-feedback"></div>
          </label>

          <!-- NOVO: Cupom -->
          <label>
            Cupom de desconto (opcional)
            <input type="text" id="coupon-code" placeholder="Digite seu cupom" autocomplete="off">
            <div class="inline-feedback" id="coupon-feedback"></div>
          </label>

          <!-- Resumo -->
          <div class="summary" aria-live="polite">
            <h3>Resumo</h3>
            <div class="summary-row">
              <span>Valor do plano</span>
              <strong id="sum-plan">—</strong>
            </div>
            <div class="summary-row">
              <span>Desconto</span>
              <strong id="sum-discount">R$ 0,00</strong>
            </div>
            <div class="summary-row">
              <span class="total">Total</span>
              <strong class="total" id="sum-total">—</strong>
            </div>
          </div>

          <!-- Campos do cartão (ilustrativos) — NÃO SÃO ENVIADOS -->
          <label style="margin-top:14px;">
            Número do cartão (ilustrativo)
            <input type="text" inputmode="numeric" maxlength="19" placeholder="0000 0000 0000 0000" required>
          </label>

          <div class="card-row">
            <label>
              Validade (MM/AA) (ilustrativo)
              <input type="text" inputmode="numeric" maxlength="5" placeholder="MM/AA" required>
            </label>
            <label>
              CVV (ilustrativo)
              <input type="password" inputmode="numeric" maxlength="4" required>
            </label>
          </div>

          <p class="note">
            Nesta fase de testes, os dados de cartão são apenas ilustrativos e <strong>não são armazenados</strong>.
          </p>

          <div class="terms-actions">
            <button type="button" class="btn-outline" id="card-cancel-btn">Cancelar</button>
            <button type="submit" class="btn-link" id="card-submit-btn">Confirmar assinatura</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-wrap">
        <div class="support">
          <p class="footer-support-title">Canais oficiais de suporte</p>
          <p class="footer-support-info">
            <a href="mailto:comercial@3g-brasil.com">comercial@3g-brasil.com</a>
          </p>
        </div>
        <div class="legal">
          <p class="footer-legal">CNPJ: 30.589.513/0001-40</p>
          <p class="footer-copy">© 2025 3G Brasil — 3g-brasil.com</p>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // ---------- API base (produção + fallback local) ----------
    var API_BASE_URL = "https://anjo-track.3g-brasil.com";
    if (location.hostname === "127.0.0.1" || location.hostname === "localhost") {
      API_BASE_URL = "http://127.0.0.1:8000";
    }

    // ---------- Helpers ----------
    function brlFromCentavos(v) {
      var n = (Number(v || 0) / 100);
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function parseCentavosFromPlano(plano) {
      // Ex.: "R$ 18,90/pessoa (R$ 75,60/mês)" => pega [18,90] e [75,60]
      var re = /R\$\s*([0-9]{1,3}(?:\.[0-9]{3})*),([0-9]{2})/g;
      var vals = [];
      var m;

      while ((m = re.exec(plano)) !== null) {
        var reais = parseInt(String(m[1]).replace(/\./g, ""), 10);
        var cents = parseInt(m[2], 10);
        vals.push(reais * 100 + cents);
      }

      if (!vals.length) return 0;

      // Se for "por pessoa" e tiver total entre parênteses, usa o ÚLTIMO valor (total)
      var isFamiliaPorPessoa = plano.toLowerCase().indexOf("pessoa") >= 0;
      if (isFamiliaPorPessoa && vals.length >= 2) return vals[vals.length - 1];

      // Caso geral: primeiro valor
      return vals[0];
    }

    function normalizeCode(s) {
      s = (s || "").trim().toUpperCase();
      s = s.replace(/\s+/g, "");
      return s;
    }

    // ---------- UI refs ----------
    var selectedPlanEl = document.getElementById("selected-plan-card");
    var sumPlanEl = document.getElementById("sum-plan");
    var sumDiscountEl = document.getElementById("sum-discount");
    var sumTotalEl = document.getElementById("sum-total");

    var couponInput = document.getElementById("coupon-code");
    var couponFeedback = document.getElementById("coupon-feedback");

    var sellerInput = document.getElementById("seller-code");
    var sellerFeedback = document.getElementById("seller-feedback");

    var submitBtn = document.getElementById("card-submit-btn");
    var cancelBtn = document.getElementById("card-cancel-btn");
    var form = document.getElementById("form-assinatura");

    var currentPlano = "—";
    var currentValorCentavos = 0;
    var currentDescontoCentavos = 0;

    function updateSummary() {
      sumPlanEl.textContent = currentValorCentavos ? brlFromCentavos(currentValorCentavos) : "—";
      sumDiscountEl.textContent = currentDescontoCentavos ? ("-" + brlFromCentavos(currentDescontoCentavos)) : brlFromCentavos(0);
      var total = Math.max(currentValorCentavos - currentDescontoCentavos, 0);
      sumTotalEl.textContent = currentValorCentavos ? brlFromCentavos(total) : "—";
    }

    // ---------- Lê plano da query string ----------
    (function initPlano() {
      var params = new URLSearchParams(window.location.search);
      var plano = params.get("plano") || "—";
      currentPlano = plano;

      if (selectedPlanEl) selectedPlanEl.textContent = plano;

      currentValorCentavos = parseCentavosFromPlano(plano);
      currentDescontoCentavos = 0;
      updateSummary();
    })();

    // ---------- Seller / Coupon ----------
    if (sellerInput) {
      sellerInput.addEventListener("input", function() {
        var v = normalizeCode(sellerInput.value);
        sellerInput.value = v;
        if (sellerFeedback) sellerFeedback.textContent = v ? "Código do vendedor registrado." : "";
      });
    }

    function previewCoupon() {
      var code = couponInput ? normalizeCode(couponInput.value) : "";
      if (!code) {
        currentDescontoCentavos = 0;
        if (couponFeedback) couponFeedback.textContent = "";
        updateSummary();
        return;
      }

      // fallback neutro (se backend não tiver preview)
      if (couponFeedback) couponFeedback.textContent = "Cupom registrado. Ele será validado na finalização.";

      // tenta preview (se existir no backend)
      fetch(API_BASE_URL + "/api/coupons/preview", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          coupon_code: code,
          plano: currentPlano,
          valor_centavos: currentValorCentavos
        })
      })
      .then(function(resp) {
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        return resp.json();
      })
      .then(function(data) {
        if (!data || data.ok !== true) {
          currentDescontoCentavos = 0;
          if (couponFeedback) couponFeedback.textContent = (data && data.reason) ? ("Cupom inválido: " + data.reason) : "Cupom inválido.";
          updateSummary();
          return;
        }
        currentDescontoCentavos = Number(data.desconto_centavos || 0);
        if (couponFeedback) couponFeedback.textContent = "Cupom aplicado.";
        updateSummary();
      })
      .catch(function() {
        // se não existe preview, mantém desconto 0 e valida só no submit
        currentDescontoCentavos = 0;
        updateSummary();
      });
    }

    if (couponInput) {
      couponInput.addEventListener("input", function() {
        couponInput.value = normalizeCode(couponInput.value);
        previewCoupon();
      });
    }

    if (cancelBtn) {
      cancelBtn.addEventListener("click", function() {
        window.location.href = "/";
      });
    }

    // ---------- Submit ----------
    if (form) {
      form.addEventListener("submit", function(e) {
        e.preventDefault();

        var nameEl = document.getElementById("card-name");
        var emailEl = document.getElementById("card-email");
        var phoneEl = document.getElementById("card-phone");
        var sellerEl = document.getElementById("seller-code");
        var couponEl = document.getElementById("coupon-code");

        var nome = (nameEl && nameEl.value ? nameEl.value : "").trim();
        var email = (emailEl && emailEl.value ? emailEl.value : "").trim();
        var phone = (phoneEl && phoneEl.value ? phoneEl.value : "").trim();

        var sellerCode = normalizeCode(sellerEl && sellerEl.value ? sellerEl.value : "");
        var couponCode = normalizeCode(couponEl && couponEl.value ? couponEl.value : "");

        if (!nome || !email || !phone || !currentPlano || !currentValorCentavos) {
          alert("Por favor, confira nome, e-mail, telefone e plano antes de continuar.");
          return;
        }

        var payload = {
          nome: nome,
          telefone: phone,
          user_email: email,
          plano: currentPlano,

          // compatibilidade com backend atual:
          valor_mensal_centavos: currentValorCentavos,

          // novos campos (tabela já tem):
          vendedor_codigo: sellerCode,

          // IMPORTANTE: escolha 1 padrão no backend.
          // Se o backend espera cupom_codigo, use cupom_codigo. Se espera coupon_code, use coupon_code.
          // Aqui envio os dois pra não quebrar sua fase atual de testes.
          cupom_codigo: couponCode,
          coupon_code: couponCode
        };

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Enviando...";
        }

        fetch(API_BASE_URL + "/api/assinaturas/site", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        })
        .then(function(resp){
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          return resp.json();
        })
        .then(function(data){
          var msg = "Assinatura registrada!";
          if (data && data.client_code) msg += "\n\nSeu código do cliente: " + data.client_code;
          if (data && data.checkout_url) msg += "\n\nLink: " + data.checkout_url;

          alert(msg);
          form.reset();
          window.location.href = "/";
        })
        .catch(function(err){
          console.error("Erro ao registrar assinatura:", err);
          alert("Não foi possível registrar sua assinatura agora. Tente novamente em alguns instantes.");
        })
        .finally(function(){
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Confirmar assinatura";
          }
        });
      });
    }
  </script>
</body>
</html>

