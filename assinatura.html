<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finalizar assinatura — Anjo da Guarda | 3G Brasil</title>
  <meta name="description" content="Finalização da assinatura do aplicativo Anjo da Guarda da 3G Brasil.">
  <link rel="stylesheet" href="assets/site.css?v=4">

  <style>
    main.container{
      max-width: 980px;
      margin: 0 auto;
      padding: 32px 16px 64px;
    }
    .page-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items:start;
    }
    .card-form-page{
      max-width: 520px;
    }
    .card-form-page label{
      display:block;
      margin-bottom:12px;
      font-size:.95rem;
    }
    .card-form-page input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size: .98rem;
      outline:none;
    }
    .card-form-page input:focus{
      border-color:#1d4ed8;
      box-shadow:0 0 0 3px rgba(29,78,216,.12);
    }

    .terms-actions{
      display:flex;
      gap:12px;
      margin-top:20px;
      flex-wrap:wrap;
    }
    .terms-actions button{
      flex:1 0 auto;
      min-width: 180px;
      min-height:48px;
      border-radius:999px;
      padding:12px 16px;
      font-weight:600;
      border:none;
      cursor:pointer;
    }
    .btn-outline{ background:#fff;border:1px solid #d1d5db;color:#111;}
    .btn-link{ background:#0b132b;color:#e8eaed;}
    .btn-outline:hover{background:#f3f4f6;}
    .btn-link:hover{opacity:.92;}

    .note{
      font-size:.9rem;
      color:#6b7280;
      margin:10px 0 0;
      line-height:1.45;
    }

    .inline-feedback{
      font-size:.85rem;
      margin-top:6px;
      color:#6b7280;
    }

    .summary{
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:14px 14px;
      background:#fafafa;
      margin-top: 10px;
    }
    .summary h3{
      margin:0 0 10px 0;
      font-size: 1rem;
    }
    .summary-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:6px 0;
      border-bottom:1px dashed #e5e7eb;
      font-size:.95rem;
    }
    .summary-row:last-child{ border-bottom:0; }
    .summary strong{ font-weight:700; }
    .summary .total{
      font-size:1.05rem;
      color:#0b132b;
    }

    @media (max-width:640px){
      .terms-actions button{ min-width: 0; flex:1; }
      .card-form-page{ max-width: 100%; }
    }
  </style>
</head>

<body>
  <header>
    <div class="logo-band">
      <img src="assets/logo.png" alt="3G Brasil" loading="lazy">
    </div>

    <nav>
      <a href="/">3G Brasil</a>
      <a href="/#produtos">Produtos</a>
      <a href="/contact.html">Contato</a>
      <a href="/cancelar.html">Cancelar assinatura</a>
    </nav>
  </header>

  <main class="container">
    <section class="page-grid">
      <div>
        <h1 style="margin:0 0 6px 0;">Finalizar assinatura</h1>
        <p class="terms-plan" style="margin:0 0 14px 0;">
          Plano selecionado: <strong id="selected-plan-card">—</strong>
        </p>

        <form class="card-form card-form-page" id="form-assinatura" onsubmit="return false;">
          <label>
            Nome completo
            <input type="text" id="card-name" autocomplete="name" required>
          </label>

          <label>
            E-mail
            <input type="email" id="card-email" autocomplete="email" required>
          </label>

          <label>
            Telefone (WhatsApp)
            <input type="tel" id="card-phone" placeholder="+55 11 99999-9999" autocomplete="tel" required>
          </label>

          <label>
            Código do vendedor (opcional)
            <input type="text" id="seller-code" placeholder="Ex.: VD-AB12" autocomplete="off">
            <div class="inline-feedback" id="seller-feedback"></div>
          </label>

          <label>
            Cupom de desconto (opcional)
            <input type="text" id="coupon-code" placeholder="Digite seu cupom" autocomplete="off">
            <div class="inline-feedback" id="coupon-feedback"></div>
          </label>

          <div class="summary" aria-live="polite">
            <h3>Resumo</h3>
            <div class="summary-row">
              <span>Valor do plano</span>
              <strong id="sum-plan">—</strong>
            </div>
            <div class="summary-row">
              <span>Desconto</span>
              <strong id="sum-discount">R$ 0,00</strong>
            </div>
            <div class="summary-row">
              <span class="total">Total</span>
              <strong class="total" id="sum-total">—</strong>
            </div>
          </div>

          <p class="note">
            Após confirmar, você será direcionado para o checkout de pagamento.
          </p>

          <div class="terms-actions">
            <button type="button" class="btn-outline" id="card-cancel-btn">Cancelar</button>
            <button type="submit" class="btn-link" id="card-submit-btn">Confirmar assinatura</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-wrap">
        <div class="support">
          <p class="footer-support-title">Canais oficiais de suporte</p>
          <p class="footer-support-info">
            <a href="mailto:comercial@3g-brasil.com">comercial@3g-brasil.com</a>
          </p>
        </div>
        <div class="legal">
          <p class="footer-legal">CNPJ: 30.589.513/0001-40</p>
          <p class="footer-copy">© 2025 3G Brasil — 3g-brasil.com</p>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // ============================
    // API base (SEM usar anjo-track)
    // ============================
    // Produção: subdomínio do "Financeiro" (separado do mapa)
    var API_BASE_URL = "https://financeiro.3g-brasil.com";

    // Local dev (financeiro_main rodando na sua máquina)
    if (location.hostname === "127.0.0.1" || location.hostname === "localhost") {
      API_BASE_URL = "http://127.0.0.1:8010";
    }

    function apiUrl(path) {
      var base = (API_BASE_URL || "").replace(/\/+$/, "");
      var p = (path || "");
      if (!p.startsWith("/")) p = "/" + p;
      return base + p;
    }

    // ---------- Helpers ----------
    function brlFromCentavos(v) {
      var n = (Number(v || 0) / 100);
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function parseCentavosFromPlano(plano) {
      // aceita "R$ 32,90" e "R$ 32.90"
      var re = /R\$\s*([0-9]{1,3}(?:\.[0-9]{3})*)(?:,|\.)([0-9]{2})/g;
      var vals = [];
      var m;

      while ((m = re.exec(plano)) !== null) {
        var reais = parseInt(String(m[1]).replace(/\./g, ""), 10);
        var cents = parseInt(m[2], 10);
        vals.push(reais * 100 + cents);
      }

      if (!vals.length) return 0;

      // Se for "por pessoa" e tiver total entre parênteses, usa o ÚLTIMO valor (total)
      var isFamiliaPorPessoa = String(plano || "").toLowerCase().indexOf("pessoa") >= 0;
      if (isFamiliaPorPessoa && vals.length >= 2) return vals[vals.length - 1];

      return vals[0];
    }

    function normalizeCode(s) {
      s = (s || "").trim().toUpperCase();
      s = s.replace(/\s+/g, "");
      return s;
    }

    function inferPeriodicidade(plano) {
      var txt = String(plano || "").toLowerCase();
      if (txt.indexOf("anual") >= 0 || txt.indexOf("/ano") >= 0 || txt.indexOf(" ano") >= 0) return "anual";
      return "mensal";
    }

    // ---------- UI refs ----------
    var selectedPlanEl = document.getElementById("selected-plan-card");
    var sumPlanEl = document.getElementById("sum-plan");
    var sumDiscountEl = document.getElementById("sum-discount");
    var sumTotalEl = document.getElementById("sum-total");

    var couponInput = document.getElementById("coupon-code");
    var couponFeedback = document.getElementById("coupon-feedback");

    var sellerInput = document.getElementById("seller-code");
    var sellerFeedback = document.getElementById("seller-feedback");

    var submitBtn = document.getElementById("card-submit-btn");
    var cancelBtn = document.getElementById("card-cancel-btn");
    var form = document.getElementById("form-assinatura");

    var currentPlano = "—";
    var currentValorCentavos = 0;
    var currentDescontoCentavos = 0;

    function updateSummary() {
      sumPlanEl.textContent = currentValorCentavos ? brlFromCentavos(currentValorCentavos) : "—";
      sumDiscountEl.textContent = currentDescontoCentavos ? ("-" + brlFromCentavos(currentDescontoCentavos)) : brlFromCentavos(0);
      var total = Math.max(currentValorCentavos - currentDescontoCentavos, 0);
      sumTotalEl.textContent = currentValorCentavos ? brlFromCentavos(total) : "—";
    }

    // botão só libera com campos obrigatórios (vendedor é opcional) + plano com valor
    function setCanSubmit() {
      if (!submitBtn || !form) return;
      var ok = form.checkValidity() && !!currentValorCentavos;
      submitBtn.disabled = !ok;
      submitBtn.style.opacity = ok ? "1" : ".6";
      submitBtn.style.cursor = ok ? "pointer" : "not-allowed";
    }

    // ---------- Lê plano da query string ----------
    (function initPlano() {
      var params = new URLSearchParams(window.location.search);
      var plano = params.get("plano") || "—";
      currentPlano = plano;

      if (selectedPlanEl) selectedPlanEl.textContent = plano;

      currentValorCentavos = parseCentavosFromPlano(plano);
      currentDescontoCentavos = 0;
      updateSummary();
      setCanSubmit();
    })();

    // Atualiza botão conforme o usuário preenche
    ["card-name","card-email","card-phone"].forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.addEventListener("input", setCanSubmit);
    });

    // ---------- Seller ----------
    if (sellerInput) {
      sellerInput.addEventListener("input", function() {
        var v = normalizeCode(sellerInput.value);
        sellerInput.value = v;
        if (sellerFeedback) sellerFeedback.textContent = v ? "Código do vendedor registrado." : "";
        setCanSubmit();
      });
    }

    // ---------- Coupon preview (REAL, via /api/assinaturas/site/preview) ----------
    var _couponTimer = null;

    function previewCoupon() {
      var code = couponInput ? normalizeCode(couponInput.value) : "";

      if (!code) {
        currentDescontoCentavos = 0;
        if (couponFeedback) couponFeedback.textContent = "";
        updateSummary();
        setCanSubmit();
        return;
      }

      if (couponFeedback) couponFeedback.textContent = "Validando cupom...";

      fetch(apiUrl("/api/assinaturas/site/preview"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          plano: currentPlano,
          periodicidade: inferPeriodicidade(currentPlano),
          valor_periodo_centavos: currentValorCentavos,
          coupon_code: code
        })
      })
      .then(function(resp){
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        return resp.json();
      })
      .then(function(data){
        currentDescontoCentavos = Number((data && data.desconto_centavos) || 0);
        updateSummary();

        if (couponFeedback) {
          if (data && data.coupon_code) couponFeedback.textContent = "Cupom aplicado.";
          else couponFeedback.textContent = "Cupom inválido (sem desconto).";
        }
        setCanSubmit();
      })
      .catch(function(){
        currentDescontoCentavos = 0;
        updateSummary();
        if (couponFeedback) couponFeedback.textContent = "Cupom registrado. Ele será validado na finalização.";
        setCanSubmit();
      });
    }

    if (couponInput) {
      couponInput.addEventListener("input", function() {
        couponInput.value = normalizeCode(couponInput.value);
        clearTimeout(_couponTimer);
        _couponTimer = setTimeout(previewCoupon, 250);
        setCanSubmit();
      });
    }

    if (cancelBtn) {
      cancelBtn.addEventListener("click", function() {
        window.location.href = "/";
      });
    }

    // ---------- Submit ----------
    if (form) {
      form.addEventListener("submit", function(e) {
        e.preventDefault();

        // obrigatórios: nome/email/telefone (HTML required) + plano com valor
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        if (!currentValorCentavos) {
          alert("Plano inválido/sem valor. Volte e selecione um plano novamente.");
          return;
        }

        var nome = (document.getElementById("card-name").value || "").trim();
        var email = (document.getElementById("card-email").value || "").trim();
        var phone = (document.getElementById("card-phone").value || "").trim();

        var sellerCode = normalizeCode(document.getElementById("seller-code").value || "");
        var couponCode = normalizeCode(document.getElementById("coupon-code").value || "");

        var periodicidade = inferPeriodicidade(currentPlano);

        // Payload compatível com routes_assinaturas_site.py (Financeiro)
        var payload = {
          nome: nome,
          telefone: phone,
          user_email: email,
          plano: currentPlano,

          // essencial p/ cálculo real do desconto
          valor_periodo_centavos: currentValorCentavos,
          valor_mensal_centavos: null,

          periodicidade: periodicidade,
          vendedor_codigo: (sellerCode || null),
          coupon_code: (couponCode || null)
        };

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Aguarde...";
        }

        fetch(apiUrl("/api/assinaturas/site"), {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        })
        .then(function(resp){
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          return resp.json();
        })
        .then(function(data){
          if (data && data.checkout_url) {
            window.location.href = data.checkout_url;
            return;
          }

          if (data && data.blocked === true) {
            var msgB = (data.reason || "Conclusão bloqueada.");
            if (data.codigo_cliente) msgB += "\n\nCódigo do cliente: " + data.codigo_cliente;
            alert(msgB);
            return;
          }

          var msg = "Assinatura registrada!";
          if (data && data.codigo_cliente) msg += "\n\nSeu código do cliente: " + data.codigo_cliente;
          alert(msg);
          window.location.href = "/";
        })
        .catch(function(err){
          console.error("Erro ao registrar assinatura:", err);
          alert("Não foi possível iniciar o checkout agora. Tente novamente em alguns instantes.");
        })
        .finally(function(){
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Confirmar assinatura";
          }
          setCanSubmit();
        });
      });
    }

    // estado inicial do botão
    setCanSubmit();
  </script>
</body>
</html>
